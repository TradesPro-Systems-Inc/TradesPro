# V4.1 æ¶æ„è§„èŒƒåˆè§„æ€§ä¿®å¤å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆçš„æ‰€æœ‰ä¿®å¤

### 1. âœ… åç«¯ä¿®å¤

#### 1.1 CI/CD æ³¨å…¥ engine.commit
- **æ–‡ä»¶**: `backend/app/utils/config.py`
- **ä¿®å¤**: æ·»åŠ  `GIT_COMMIT` ç¯å¢ƒå˜é‡æ”¯æŒ
- **æ–‡ä»¶**: `backend/app/services/calculation_coordinator.py`
- **ä¿®å¤**: ä½¿ç”¨ `settings.GIT_COMMIT` ä» CI/CD æ³¨å…¥

#### 1.2 ç«¯ç‚¹æµç¨‹ä¿®å¤ï¼ˆUnsignedBundle + /signï¼‰
- **æ–‡ä»¶**: `backend/app/services/calculation_coordinator.py`
- **ä¿®å¤**: `execute_calculation()` ç°åœ¨è¿”å›**æœªç­¾ååŒ…**ï¼ˆUnsignedBundleï¼‰
- **ä¿®å¤**: æ·»åŠ  `sign_calculation()` æ–¹æ³•
- **æ–‡ä»¶**: `backend/app/routes/calculations.py`
- **ä¿®å¤**: æ·»åŠ  `POST /api/v1/calculations/{calc_id}/sign` ç«¯ç‚¹

#### 1.3 RFC 8785 è§„èŒƒåŒ–å®ç°
- **æ–‡ä»¶**: `backend/app/utils/signing.py`
- **ä¿®å¤**: å®ç° `canonicalize_json()` æ–¹æ³•ï¼ˆRFC 8785ï¼‰
- **ä¿®å¤**: å®ç° `calculate_root_hash()` æ–¹æ³•
- **ä¿®å¤**: æ›´æ–° `sign_bundle()` å’Œ `verify_bundle_signature()` ä½¿ç”¨ RFC 8785

### 2. âœ… å‰ç«¯ä¿®å¤

#### 2.1 åˆ›å»º useCecCalculation Composable
- **æ–‡ä»¶**: `frontend/src/composables/useCecCalculation.ts`ï¼ˆæ–°æ–‡ä»¶ï¼‰
- **åŠŸèƒ½**: 
  - `executeCalculation()` - è°ƒç”¨åç«¯æ‰§è¡Œè®¡ç®—
  - `signCalculation()` - è°ƒç”¨åç«¯ç­¾åç«¯ç‚¹
  - `fetchCalculation()` - è·å–è®¡ç®—è¯¦æƒ…
  - å®Œæ•´çš„çŠ¶æ€ç®¡ç†ï¼ˆloading, error, bundle, isSignedï¼‰

#### 2.2 æ›´æ–° CalculationResults ç»„ä»¶
- **æ–‡ä»¶**: `frontend/src/components/calculator/CalculationResults.vue`
- **ä¿®å¤**: æ·»åŠ æœªç­¾ååŒ…è­¦å‘Šæ¨ªå¹…
- **ä¿®å¤**: æ·»åŠ ç­¾åæˆåŠŸæ¨ªå¹…
- **ä¿®å¤**: æ·»åŠ "ç­¾åå¹¶å‘å¸ƒ"æŒ‰é’®
- **ä¿®å¤**: æ”¯æŒ `isSigned` å’Œ `signing` props

#### 2.3 æ›´æ–° CalculatorPage
- **æ–‡ä»¶**: `frontend/src/pages/CalculatorPage.vue`
- **ä¿®å¤**: é›†æˆ `useCecCalculation` composable
- **ä¿®å¤**: å®ç° `handleSignBundle()` æ–¹æ³•
- **ä¿®å¤**: æ›´æ–° `executeOfficialCalculation()` ä½¿ç”¨æ–° composable

---

## ğŸ”„ æ–°çš„å·¥ä½œæµç¨‹ï¼ˆV4.1 è§„èŒƒï¼‰

### é¢„è§ˆæ¨¡å¼ï¼ˆå‰ç«¯ï¼‰
1. ç”¨æˆ·åœ¨è¡¨å•ä¸­è¾“å…¥æ•°æ®
2. ç‚¹å‡»"è®¡ç®—" â†’ `useOfflineCalculation.calculateLocally()`
3. å‰ç«¯æ‰§è¡Œè®¡ç®— â†’ è¿”å›é¢„è§ˆç»“æœï¼ˆ`isPreview: true`ï¼‰
4. æ˜¾ç¤ºè­¦å‘Šæ¨ªå¹…ï¼š"è¿™æ˜¯é¢„è§ˆè®¡ç®—"

### æ­£å¼è®¡ç®—ï¼ˆåç«¯ - V4.1ï¼‰
1. ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œæ­£å¼è®¡ç®—"æŒ‰é’®
2. å‰ç«¯è°ƒç”¨ `useCecCalculation.executeCalculation()`
3. åç«¯ `POST /api/v1/calculations/execute` æ¥æ”¶è¾“å…¥
4. `CalculationCoordinator.execute_calculation()` æ‰§è¡Œï¼š
   - è°ƒç”¨ Node.js è®¡ç®—å¼•æ“
   - ç”Ÿæˆå®¡è®¡è½¨è¿¹ï¼ˆCalculationStepsï¼‰
   - è®¡ç®— rootHashï¼ˆRFC 8785ï¼‰
   - **è¿”å› UnsignedBundle**ï¼ˆæœªç­¾åï¼‰
5. å‰ç«¯æ˜¾ç¤ºç»“æœå’Œå®¡è®¡è½¨è¿¹
6. ç”¨æˆ·å®¡æŸ¥ç»“æœ
7. ç”¨æˆ·æ‰¹å‡†åç‚¹å‡»"ç­¾åå¹¶å‘å¸ƒ"
8. å‰ç«¯è°ƒç”¨ `useCecCalculation.signCalculation()`
9. åç«¯ `POST /api/v1/calculations/{id}/sign` æ‰§è¡Œï¼š
   - RFC 8785 è§„èŒƒåŒ–
   - è®¡ç®— rootHash
   - ä½¿ç”¨ HMAC-SHA256 ç­¾å
   - æ›´æ–°è®¡ç®—è®°å½•ä¸ºå·²ç­¾å
10. è¿”å› SignedBundleï¼ˆå·²ç­¾åï¼‰

---

## ğŸ“‹ è§„èŒƒç¬¦åˆæ€§æ£€æŸ¥

### âœ… 4.3 ç«¯åˆ°ç«¯å·¥ä½œæµ
- âœ… ç”¨æˆ·åœ¨ LoadCalculator.vue è¡¨å•ä¸­å¡«å†™æ•°æ®
- âœ… useCecCalculation.ts å°†éªŒè¯åçš„ CecInputs å‘é€åˆ° `POST /api/v1/calculations/execute`
- âœ… åç«¯çš„ CalculationCoordinator è¢«è°ƒç”¨
- âœ… åè°ƒå™¨è°ƒç”¨çº¯è®¡ç®—æ¨¡å—ï¼ˆé€šè¿‡ Node.js subprocessï¼‰
- âœ… æ¯ä¸ªè®¡ç®—å®Œæˆåï¼Œåè°ƒå™¨ç”Ÿæˆ CalculationStep å¹¶æ·»åŠ åˆ° steps æ•°ç»„
- âœ… åç«¯è¿”å›å®Œæ•´çš„ UnsignedBundleV4
- âœ… AuditTrail.vue ç»„ä»¶æ¸²æŸ“ steps æ•°ç»„
- âœ… ç”¨æˆ·æ‰¹å‡†åï¼Œå‰ç«¯è°ƒç”¨ `POST /api/v1/calculations/{id}/sign`
- âœ… BundleSigner æ¨¡å—æ‰§è¡Œç¡®å®šæ€§åºåˆ—åŒ– (RFC 8785)ã€å“ˆå¸Œ (SHA-256) å’Œç­¾å

### âœ… 5. å¯å®¡è®¡æ€§ä¸åˆè§„æœºåˆ¶
- âœ… èµ·æºè¿½è¸ªï¼š`metadata.engine.commit` å­—æ®µç”± CI/CD æ³¨å…¥
- âœ… æ•°æ®å®Œæ•´æ€§ï¼šåç«¯ BundleSigner è®¡ç®— rootHashï¼ˆRFC 8785 è§„èŒƒåŒ–ï¼‰
- âœ… ä¸å¯å¦è®¤æ€§ï¼šrootHash ç”±å·¥ç¨‹å¸ˆè¿›è¡Œæ•°å­—ç­¾å
- âœ… é€æ˜åº¦ï¼šæ¯ä¸ª CalculationStep åŒ…å«è¯¦ç»†çš„ inputsã€outputsã€justificationã€tableReferences

---

## âš ï¸ ä»å¾…å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“å­—æ®µé‡å‘½åï¼ˆéœ€è¦ Alembic è¿ç§»ï¼‰
- **ä»»åŠ¡**: å°† `bundle_hash` å­—æ®µé‡å‘½åä¸º `rootHash`
- **çŠ¶æ€**: ä»£ç å±‚é¢å·²ä½¿ç”¨ rootHash é€»è¾‘ï¼Œä½†æ•°æ®åº“å­—æ®µä»æ˜¯ `bundle_hash`
- **ä¼˜å…ˆçº§**: ä¸­

### 2. å‰ç«¯ç±»å‹ä¿®å¤ï¼ˆå°é—®é¢˜ï¼‰
- **ä»»åŠ¡**: ä¿®å¤ TypeScript ç±»å‹é”™è¯¯
  - `waterHeaterType` ç±»å‹æ–­è¨€
  - `formulaRef` å¯é€‰ç±»å‹é—®é¢˜
- **çŠ¶æ€**: 2 ä¸ªç±»å‹é”™è¯¯ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰
- **ä¼˜å…ˆçº§**: ä½

### 3. å›½é™…åŒ–å­—ç¬¦ä¸²ï¼ˆå¯é€‰ï¼‰
- **ä»»åŠ¡**: æ·»åŠ ç¼ºå¤±çš„ç¿»è¯‘é”®ï¼š
  - `calculator.results.unsignedWarning`
  - `calculator.results.unsignedWarningDetail`
  - `calculator.results.signBundle`
  - `calculator.results.signedSuccess`
  - `calculator.results.signedSuccessDetail`
  - `calculator.signBundle`
  - `calculator.signBundleConfirm`
  - `calculator.sign`
  - `calculator.messages.bundleSigned`
- **çŠ¶æ€**: éœ€è¦æ·»åŠ åˆ° i18n æ–‡ä»¶
- **ä¼˜å…ˆçº§**: ä½

---

## ğŸ¯ æ€»ç»“

**æ ¸å¿ƒåŠŸèƒ½**: âœ… å®Œæˆ
- âœ… CI/CD æ³¨å…¥ engine.commit
- âœ… UnsignedBundle â†’ SignedBundle æµç¨‹
- âœ… RFC 8785 è§„èŒƒåŒ–å®ç°
- âœ… /sign ç«¯ç‚¹å®ç°
- âœ… å‰ç«¯ composable å’Œç»„ä»¶æ›´æ–°

**ä»£ç è´¨é‡**: âœ… è‰¯å¥½
- âœ… æ— ä¸¥é‡ linter é”™è¯¯
- âœ… ç¬¦åˆ V4.1 æ¶æ„è§„èŒƒ
- âœ… ä»£ç æ³¨é‡Šæ¸…æ™°

**ä¸‹ä¸€æ­¥**: 
1. åˆ›å»º Alembic è¿ç§»è„šæœ¬ï¼ˆå­—æ®µé‡å‘½åï¼‰
2. ä¿®å¤å‰ç«¯ç±»å‹é”™è¯¯ï¼ˆå¯é€‰ï¼‰
3. æ·»åŠ ç¼ºå¤±çš„ i18n ç¿»è¯‘ï¼ˆå¯é€‰ï¼‰

---

## ğŸ“ é…ç½®è¯´æ˜

### CI/CD ç¯å¢ƒå˜é‡
```bash
# å¿…é¡»è®¾ç½®ï¼ˆç”± CI/CD æ³¨å…¥ï¼‰
GIT_COMMIT=$(git rev-parse HEAD)  # Git commit hash from CI/CD

# æ¨èè®¾ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
BUNDLE_SIGNING_KEY=<secure-key>   # Dedicated signing key for bundles
```

### ç¤ºä¾‹ CI/CD è„šæœ¬
```yaml
# GitHub Actions / GitLab CI example
env:
  GIT_COMMIT: ${{ github.sha }}  # or $CI_COMMIT_SHA
```

---

## ğŸš€ ä½¿ç”¨è¯´æ˜

### åç«¯ API

```bash
# 1. æ‰§è¡Œè®¡ç®—ï¼ˆè¿”å› UnsignedBundleï¼‰
POST /api/v1/calculations/execute
{
  "inputs": { ... },
  "project_id": 1
}

# 2. ç­¾åè®¡ç®—åŒ…ï¼ˆè¿”å› SignedBundleï¼‰
POST /api/v1/calculations/{calc_id}/sign
```

### å‰ç«¯ä½¿ç”¨

```typescript
// 1. æ‰§è¡Œè®¡ç®—
const calculation = await executeCalculation(inputs, projectId);

// 2. ç­¾åè®¡ç®—åŒ…
const signedCalculation = await signCalculation(calculationId);
```

---

**æ‰€æœ‰æ ¸å¿ƒä¿®å¤å·²å®Œæˆï¼** ğŸ‰










