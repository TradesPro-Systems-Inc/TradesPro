# V4.1 架构规范合规性审查报告

## 发现的不符合项

### 1. ❌ 端点流程不符合规范

**规范要求：**
- `POST /api/v1/calculations` 应该返回 **UnsignedBundle**（未签名包）
- `POST /api/v1/calculations/{id}/sign` 用于用户批准后签名

**当前实现：**
- `POST /api/v1/calculations/execute` 直接返回**已签名**的结果
- 缺少 `/sign` 端点

**影响：**
- 用户无法在签名前审查计算结果
- 不符合“用户批准后再签名”的流程

---

### 2. ❌ 字段命名不符合规范

**规范要求：**
- 使用 `rootHash` 字段名

**当前实现：**
- 使用 `bundle_hash` 字段名
- 数据库模型、服务层、签名层都使用了 `bundle_hash`

**影响：**
- 与规范不一致，可能导致前端/第三方集成问题

---

### 3. ❌ RFC 8785 规范化缺失

**规范要求：**
- 使用 RFC 8785 (JSON Canonicalization Scheme - JCS) 进行确定性序列化
- 规范化后再计算 SHA-256 hash

**当前实现：**
- 使用 `json.dumps(sort_keys=True)` - 这不是 RFC 8785
- RFC 8785 有更严格的规范：
  - 属性排序规则
  - 数字格式化规则（固定小数位数）
  - 字符串规范化（NFC Unicode）
  - I-JSON 子集

**影响：**
- Hash 值可能与其他实现不一致
- 不符合 RFC 8785 标准

---

### 4. ❌ engine.commit 未从 CI/CD 注入

**规范要求：**
- `engine.commit` 字段**必须**由 CI/CD 流水线注入
- 将每个计算与其产出的确切代码版本链接起来

**当前实现：**
- 硬编码为 `"TODO: Git commit hash"` (calculation_coordinator.py:80)

**影响：**
- 无法追踪计算结果的代码版本
- 违反“起源追踪”要求

---

### 5. ❌ 签名流程不符合规范

**规范要求：**
- 先返回未签名包 (`UnsignedBundle`)
- 用户审查后调用 `/sign` 端点
- 后端执行确定性序列化 (RFC 8785) → 哈希 (SHA-256) → 签名

**当前实现：**
- 计算后立即签名，用户无法审查未签名结果
- 签名使用 HMAC-SHA256（符合规范，但规范建议使用 RSA/ECDSA 用于生产）

---

### 6. ⚠️ CalculationStep 内容完整性

**规范要求：**
- 每个 CalculationStep 必须包含：
  - `inputs`: 详细的输入引用
  - `outputs`: 输出结果
  - `justification`: 计算依据（或通过 ruleCitations/note 提供）
  - `tableReferences`: 表格引用

**当前实现：**
- 步骤从计算引擎返回，然后被协调器增强
- 需要验证是否包含所有必需字段

---

## 需要修复的文件

1. **后端路由** (`backend/app/routes/calculations.py`):
   - 修改 `/execute` 端点返回未签名包
   - 添加 `/sign` 端点

2. **计算协调器** (`backend/app/services/calculation_coordinator.py`):
   - 修改 `execute_calculation` 不立即签名
   - 添加 `sign_calculation` 方法

3. **签名工具** (`backend/app/utils/signing.py`):
   - 实现 RFC 8785 规范化（或使用库）
   - 将 `bundle_hash` 改为 `rootHash`

4. **模型** (`backend/app/models/calculation.py`):
   - 将 `bundle_hash` 字段改为 `rootHash`

5. **数据库迁移**:
   - 重命名 `bundle_hash` 列

6. **配置** (`backend/app/utils/config.py`):
   - 添加 `GIT_COMMIT` 环境变量支持
   - 在构建时从 CI/CD 注入

---

## 优先级

1. **高优先级**（核心合规性）:
   - 端点流程修改（UnsignedBundle + /sign）
   - engine.commit 注入
   - RFC 8785 实现

2. **中优先级**（一致性）:
   - 字段重命名 (bundle_hash → rootHash)

3. **低优先级**（增强）:
   - CalculationStep 内容验证










