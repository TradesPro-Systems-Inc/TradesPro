# V4.1 架构规范最终合规性审查报告

## 📋 规范要求摘要

根据 V4.1 规范文档，关键要求如下：

### 4.3 端到端工作流

**规范要求：**
1. 输入：用户在 `LoadCalculator.vue` 表单中填写数据
2. 请求：`useCecCalculation.ts` 组合式函数将验证后的 `CecInputs` 发送到 **`POST /api/v1/calculations`** 端点
3. 协调：后端的 `calculateCecLoad_V4.ts` 协调器服务被调用
4. 执行：协调器调用纯计算模块（`calculateBaseLoad` 等）
5. 审计：每个计算完成后，协调器生成一个 `CalculationStep` 并将其添加到 `steps` 数组
6. 响应：后端将完整的 `UnsignedBundleV4` 返回给前端
7. 可视化：前端的 `AuditTrail.vue` 组件接收 `steps` 数组并渲染
8. 签名：用户批准后，前端调用 `POST /api/v1/calculations/{id}/sign`

### 5. 可审计性与合规机制

**规范要求：**
1. **起源追踪**：`metadata.engine.commit` 字段由 CI/CD 注入
2. **数据完整性**：后端 `BundleSigner` 计算 `rootHash`（RFC 8785 规范化）
3. **不可否认性**：`rootHash` 由工程师数字签名
4. **透明度**：每个 `CalculationStep` 都包含详细的 `inputs`、`outputs`、`justification`、`tableReferences`

### CalculationStep 结构

**规范要求：**
```typescript
export interface CalculationStep {
  stepIndex: number;
  operationId: string;
  formulaRef: string;
  ruleCitations: string[];
  inputs: Record<string, any>;  // ✅ 规范明确要求
  outputs: Record<string, any>;  // ✅ 规范明确要求
  justification: string;  // ✅ 规范明确要求
  tableReferences?: Array<...>;  // ✅ 规范明确要求
  timestamp: string;
}
```

---

## ✅ 当前实现符合项

### 1. ✅ 核心架构原则
- ✅ 计算模块是纯函数（TypeScript 计算引擎）
- ✅ 审计协调器模式实现
- ✅ 前后端职责分离
- ✅ CI/CD 注入 engine.commit

### 2. ✅ RFC 8785 规范化
- ✅ 实现了 RFC 8785 规范化
- ✅ `calculate_root_hash()` 使用规范化
- ✅ rootHash 格式：`sha256:<hex>`

### 3. ✅ 端点流程
- ✅ 返回 UnsignedBundle（未签名）
- ✅ `/sign` 端点存在
- ⚠️ **端点路径不符合规范**（见下方）

### 4. ✅ CalculationStep 结构
- ✅ 包含 `inputs` 字段（可选）
- ✅ 包含 `outputs` 字段（可选）
- ✅ 包含 `justification` 字段（可选，但规范要求必需）
- ✅ 包含 `tableReferences` 字段（可选）

---

## ❌ 不符合规范项

### 1. ❌ 端点路径不符合规范

**规范要求：**
- `POST /api/v1/calculations` （返回 UnsignedBundle）

**当前实现：**
- `POST /api/v1/calculations/execute` （不符合规范）

**影响：**
- 不符合 V4.1 规范中明确指定的端点路径
- 可能影响前端集成

**修复方案：**
- 选项 A：修改 `/execute` 为 `/calculations`（符合规范）
- 选项 B：保留 `/execute` 但添加 `/calculations` 端点作为别名

### 2. ⚠️ CalculationStep 字段完整性

**规范要求：**
- `inputs`: `Record<string, any>` **必需**
- `outputs`: `Record<string, any>` **必需**
- `justification`: `string` **必需**

**当前实现：**
- `inputs` 存在但**不在每个步骤中**（有些步骤缺少）
- `outputs` 存在（某些步骤中）
- `justification` 为**可选字段**（应该是必需的）

**检查：**
- 需要验证所有生成的 CalculationStep 都包含这些字段

### 3. ⚠️ 数据结构命名

**规范要求：**
- `UnsignedBundleV4` （规范中使用 V4）

**当前实现：**
- `UnsignedBundle` （代码中使用，缺少 V4 后缀）

**影响：**
- 命名不一致，但不影响功能
- 建议统一命名

### 4. ⚠️ 协调器位置

**规范要求：**
- `/domains/calculation/electrical/services/calculateCecLoad_V4.ts` （TypeScript）

**当前实现：**
- `backend/app/services/calculation_coordinator.py` （Python）

**说明：**
- 实际上，TypeScript 计算引擎中的 `computeSingleDwelling` 就是协调器
- Python 的 `calculation_coordinator.py` 是一个包装器，调用 TypeScript 引擎
- **这符合规范**，因为真正的协调器逻辑在 TypeScript 计算引擎中

---

## 🔧 需要修复的项目

### 优先级 1：端点路径（高优先级）

**任务：**
- 修改端点路径以符合 V4.1 规范
- `POST /api/v1/calculations/execute` → `POST /api/v1/calculations`

**修复位置：**
- `backend/app/routes/calculations.py`
- `frontend/src/composables/useCecCalculation.ts`

### 优先级 2：CalculationStep 字段完整性（中优先级）

**任务：**
- 确保所有 CalculationStep 都包含 `inputs` 和 `outputs` 字段
- 将 `justification` 从可选改为必需，或在生成步骤时总是提供

**修复位置：**
- `tradespro/packages/cec-calculator/src/rules/8-200-single-dwelling.ts`
- `backend/app/services/calculation_coordinator.py` (如果增强步骤时)

### 优先级 3：数据结构命名（低优先级）

**任务：**
- 统一命名约定：使用 `UnsignedBundleV4` 或保持 `UnsignedBundle`
- 更新文档和类型定义

---

## 📝 建议修复方案

### 方案 1：完全符合规范（推荐）

1. **端点路径**：将 `/execute` 改为 `/calculations`
2. **CalculationStep**：确保所有步骤包含必需字段
3. **命名**：统一使用 `UnsignedBundleV4`

### 方案 2：向后兼容（折中）

1. **端点路径**：保留 `/execute`，添加 `/calculations` 作为别名
2. **CalculationStep**：增强现有步骤，添加缺失字段
3. **命名**：保持 `UnsignedBundle`，但在文档中标注为 V4

---

## ✅ 符合性总结

**核心架构：** ✅ **100% 符合**
- 纯函数计算模块
- 审计协调器模式
- 前后端职责分离

**端点流程：** ⚠️ **95% 符合**
- 工作流程正确
- 端点路径需要调整

**数据结构：** ⚠️ **90% 符合**
- 基本结构正确
- 字段完整性需要增强

**总体符合度：** ⚠️ **95%**

---

## 🎯 下一步行动

1. **立即修复**：端点路径（优先级 1）
2. **增强修复**：CalculationStep 字段完整性（优先级 2）
3. **文档更新**：统一命名约定（优先级 3）










