# V4.1 Plugin System å®ç°å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. Plugin ç³»ç»Ÿæ ¸å¿ƒæ¶æ„ âœ…

å·²åˆ›å»ºå®Œæ•´çš„ plugin ç³»ç»ŸåŸºç¡€è®¾æ–½ï¼š

#### æ–‡ä»¶ç»“æ„
```
src/plugins/
â”œâ”€â”€ types.ts                              # âœ… Pluginç±»å‹å®šä¹‰
â”œâ”€â”€ registry.ts                           # âœ… Pluginæ³¨å†Œè¡¨
â”œâ”€â”€ loader.ts                             # âœ… PluginåŠ è½½å™¨ï¼ˆé›†æˆå®‰å…¨éªŒè¯ï¼‰
â”œâ”€â”€ signatureVerifier.ts                  # âœ… ç­¾åéªŒè¯å™¨ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ sandboxRunner.ts                      # âœ… æ²™ç®±æ‰§è¡Œå™¨ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ index.ts                              # âœ… Pluginç³»ç»Ÿå…¥å£
â”œâ”€â”€ builtin/
â”‚   â”œâ”€â”€ cec-single-dwelling-plugin.ts    # âœ… CECæ’ä»¶å®ç°
â”‚   â””â”€â”€ nec-single-dwelling-plugin.ts    # âœ… NECæ’ä»¶å®ç°
```

#### æ ¸å¿ƒåŠŸèƒ½
- âœ… **Plugin Registry**: æ’ä»¶æ³¨å†Œã€æŸ¥æ‰¾ã€ç®¡ç†
- âœ… **Plugin Loader**: æ’ä»¶åŠ è½½ã€éªŒè¯ã€æ‰§è¡Œï¼ˆé›†æˆå®‰å…¨éªŒè¯ï¼‰
- âœ… **Plugin Types**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
- âœ… **Plugin Context**: è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æä¾›
- âœ… **Built-in Plugins**: CECå’ŒNECæ’ä»¶è‡ªåŠ¨æ³¨å†Œ
- âœ… **Signature Verifier**: æ’ä»¶ç­¾åå’Œæ ¡éªŒå’ŒéªŒè¯ï¼ˆæ–°å¢ï¼‰
- âœ… **Sandbox Runner**: æ’ä»¶æ²™ç®±æ‰§è¡Œç¯å¢ƒï¼ˆæ–°å¢ï¼‰

---

### 2. CEC Single Dwelling Plugin âœ…

**æ–‡ä»¶**: `src/plugins/builtin/cec-single-dwelling-plugin.ts`

**åŠŸèƒ½**:
- âœ… åŒ…è£…ç°æœ‰çš„ `computeSingleDwelling` å‡½æ•°
- âœ… å®ç° `CalculationPlugin` æ¥å£
- âœ… è¾“å…¥éªŒè¯
- âœ… å®Œæ•´çš„ manifest å®šä¹‰
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**Plugin ID**: `cec-single-dwelling-2024`

**ä½¿ç”¨æ–¹æ³•**:
```typescript
import { executePlugin, createPluginContext } from '@tradespro/calculation-engine';

const context = createPluginContext(engineMeta, tables);
const result = await executePlugin('cec-single-dwelling-2024', inputs, context);
```

---

### 3. NEC Single Dwelling Plugin âœ…

**æ–‡ä»¶**: `src/plugins/builtin/nec-single-dwelling-plugin.ts`

**åŠŸèƒ½**:
- âœ… åŒ…è£…ç°æœ‰çš„ `computeNECSingleDwelling` å‡½æ•°
- âœ… å®ç° `CalculationPlugin` æ¥å£
- âœ… æ”¯æŒ Standard å’Œ Optional æ–¹æ³•
- âœ… è¾“å…¥éªŒè¯
- âœ… å®Œæ•´çš„ manifest å®šä¹‰

**Plugin ID**: `nec-single-dwelling-2023`

**ä½¿ç”¨æ–¹æ³•**:
```typescript
// Standard Method
const context = createPluginContext(engineMeta, tables, {
  necMethod: 'standard',
});

// Optional Method
const context2 = createPluginContext(engineMeta, tables, {
  necMethod: 'optional',
});

const result = await executePlugin('nec-single-dwelling-2023', inputs, context);
```

---

### 4. æ–‡æ¡£ âœ…

- âœ… **PLUGIN_SYSTEM.md**: å®Œæ•´çš„pluginç³»ç»Ÿæ–‡æ¡£
  - æ¶æ„è®¾è®¡
  - ä½¿ç”¨æ–¹æ³•
  - å¼€å‘æŒ‡å—
  - æœ€ä½³å®è·µ
  - è¿ç§»æŒ‡å—

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. ç»Ÿä¸€æ¥å£
æ‰€æœ‰è®¡ç®—åŠŸèƒ½ç°åœ¨éƒ½é€šè¿‡ç»Ÿä¸€çš„ plugin æ¥å£è°ƒç”¨ï¼Œç®€åŒ–äº†ä»£ç ç»“æ„ã€‚

### 2. è‡ªåŠ¨æ³¨å†Œ
å†…ç½®æ’ä»¶ï¼ˆCECå’ŒNECï¼‰åœ¨å¯¼å…¥æ—¶è‡ªåŠ¨æ³¨å†Œï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

### 3. ç±»å‹å®‰å…¨
å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰ï¼Œæä¾›è‰¯å¥½çš„å¼€å‘ä½“éªŒã€‚

### 4. æ‰©å±•æ€§
æ–°åŠŸèƒ½å¯ä»¥è½»æ¾åœ°ä½œä¸º plugin å¼€å‘ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚

### 5. å‘åå…¼å®¹
åŸæœ‰çš„ `computeSingleDwelling` å’Œ `computeNECSingleDwelling` å‡½æ•°ä»ç„¶å¯ç”¨ï¼Œplugin ç³»ç»Ÿæ˜¯å¯¹ç°æœ‰åŠŸèƒ½çš„å°è£…ã€‚

---

## ğŸ“Š ä½¿ç”¨ç»Ÿè®¡

### å†…ç½®æ’ä»¶æ•°é‡
- âœ… CEC Single Dwelling: 1
- âœ… NEC Single Dwelling: 1
- **æ€»è®¡**: 2ä¸ªå†…ç½®æ’ä»¶

### æ”¯æŒçš„æ ‡å‡†
- âœ… CEC 2024 (Section 8-200)
- âœ… NEC 2023 (Article 220)

### æ”¯æŒçš„å»ºç­‘ç±»å‹
- âœ… single-dwelling

---

## ğŸ”„ è¿ç§»è·¯å¾„

### ä»ç›´æ¥è°ƒç”¨è¿ç§»

**æ—§æ–¹å¼** (ä»ç„¶æ”¯æŒ):
```typescript
import { computeSingleDwelling } from '@tradespro/calculation-engine';
const bundle = computeSingleDwelling(inputs, engineMeta, tables);
```

**æ–°æ–¹å¼** (æ¨è):
```typescript
import { executePlugin, createPluginContext } from '@tradespro/calculation-engine';
const context = createPluginContext(engineMeta, tables);
const result = await executePlugin('cec-single-dwelling-2024', inputs, context);
const bundle = result.bundle;
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸ (å·²è§„åˆ’)
- [ ] æ›´æ–°å‰ç«¯ä»£ç ä½¿ç”¨ plugin ç³»ç»Ÿ
- [ ] æ›´æ–°åç«¯ä»£ç ä½¿ç”¨ plugin ç³»ç»Ÿ
- [ ] æ·»åŠ  plugin å•å…ƒæµ‹è¯•

### ä¸­æœŸ (è®¡åˆ’ä¸­)
- [ ] Plugin å¸‚åœº/å•†åº—
- [ ] Plugin ç­¾åéªŒè¯
- [ ] Plugin æ²™ç®±ç¯å¢ƒ
- [ ] Plugin çƒ­é‡è½½

### é•¿æœŸ (æœªæ¥)
- [ ] ç¬¬ä¸‰æ–¹ plugin æ”¯æŒ
- [ ] Plugin ç‰ˆæœ¬ç®¡ç†
- [ ] Plugin ä¾èµ–è§£æ
- [ ] Plugin æ€§èƒ½ç›‘æ§

---

## ğŸ“ å¼€å‘è€…æŒ‡å—

### åˆ›å»ºæ–° Plugin

1. åˆ›å»º plugin æ–‡ä»¶ï¼Œå®ç° `CalculationPlugin` æ¥å£
2. å®šä¹‰ manifest
3. å®ç° `calculate` æ–¹æ³•
4. å¯é€‰ï¼šå®ç° `validateInputs` å’Œç”Ÿå‘½å‘¨æœŸé’©å­
5. æ³¨å†Œ plugin

å‚è€ƒ `src/plugins/builtin/` ä¸­çš„ç¤ºä¾‹ã€‚

### æµ‹è¯• Plugin

```typescript
import { executePlugin, createPluginContext } from '@tradespro/calculation-engine';

// å‡†å¤‡æµ‹è¯•æ•°æ®
const inputs = { /* ... */ };
const engineMeta = { /* ... */ };
const tables = await tableManager.loadTables('2024');
const context = createPluginContext(engineMeta, tables);

// æ‰§è¡Œæµ‹è¯•
const result = await executePlugin('your-plugin-id', inputs, context);
console.assert(result.bundle !== null);
```

---

## âœ… éªŒè¯æ¸…å•

- [x] Plugin ç³»ç»Ÿæ ¸å¿ƒæ¶æ„å®Œæˆ
- [x] CEC plugin å®ç°å®Œæˆ
- [x] NEC plugin å®ç°å®Œæˆ
- [x] Plugin Registry åŠŸèƒ½å®Œæ•´
- [x] Plugin Loader åŠŸèƒ½å®Œæ•´
- [x] TypeScript ç±»å‹å®šä¹‰å®Œæ•´
- [x] æ–‡æ¡£å®Œæˆ
- [x] è‡ªåŠ¨æ³¨å†Œæœºåˆ¶å®ç°
- [x] å‘åå…¼å®¹æ€§ä¿æŒ

---

## ğŸ‰ æ€»ç»“

V4.1 Plugin System å·²ç»æˆåŠŸå®ç°ï¼ç°åœ¨ï¼š

1. âœ… **CEC Single Dwelling** è®¡ç®—å™¨å·²è½¬æ¢ä¸º plugin æ–¹å¼
2. âœ… **NEC Single Dwelling** è®¡ç®—å™¨å·²è½¬æ¢ä¸º plugin æ–¹å¼
3. âœ… æä¾›äº†å®Œæ•´çš„ plugin æ ‡å‡†å’Œæ¥å£
4. âœ… æ”¯æŒæœªæ¥åŠŸèƒ½çš„ plugin æ–¹å¼å¼€å‘
5. âœ… ä¸ºç¬¬ä¸‰æ–¹å¼€å‘è€…å‚ä¸å¥ å®šäº†åŸºç¡€

æ‰€æœ‰åŠŸèƒ½ç°åœ¨éƒ½å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„ plugin æ¥å£è°ƒç”¨ï¼Œä¸ºå¹³å°çš„æ‰©å±•æ€§å’Œç¤¾åŒºå‚ä¸æ‰“å¼€äº†å¤§é—¨ï¼

---

**å®ç°æ—¥æœŸ**: 2025-01-XX
**ç‰ˆæœ¬**: 1.1.0 (æ–°å¢å®‰å…¨ç‰¹æ€§)
**çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ”’ æ–°å¢å®‰å…¨åŠŸèƒ½å®ç° (v1.1.0)

### 7. ç­¾åéªŒè¯å™¨ (signatureVerifier.ts)

å®Œæ•´çš„ç­¾åå’Œæ ¡éªŒå’ŒéªŒè¯å®ç°ï¼š

```typescript
// @tradespro/calculation-engine/src/plugins/signatureVerifier.ts
import crypto from 'crypto';

/**
 * è®¡ç®— manifest æ ¡éªŒå’Œ
 */
export function computeChecksum(manifestObj: any): string {
  const canon = canonicalize(manifestObj);
  const hash = crypto.createHash('sha256').update(canon, 'utf8').digest('hex');
  return hash;
}

/**
 * éªŒè¯ manifest ç­¾å
 */
export function verifySignature(
  manifestObj: any,
  signatureBase64: string,
  publicKeyPem: string
): boolean {
  const canon = canonicalManifestBytes(manifestObj, true);
  const signature = Buffer.from(signatureBase64, 'base64');
  const verify = crypto.createVerify('sha256');
  verify.update(canon);
  verify.end();
  return verify.verify(publicKeyPem, signature);
}

/**
 * ç­¾å manifest
 */
export function signManifest(manifestObj: any, privateKeyPem: string): string {
  const canon = canonicalManifestBytes(manifestObj, true);
  const sign = crypto.createSign('sha256');
  sign.update(canon);
  sign.end();
  const sig = sign.sign(privateKeyPem);
  return sig.toString('base64');
}
```

### 8. æ²™ç®±æ‰§è¡Œå™¨ (sandboxRunner.ts)

æ”¯æŒ vm2 å’ŒåŸç”Ÿ vm çš„æ²™ç®±æ‰§è¡Œï¼š

```typescript
// @tradespro/calculation-engine/src/plugins/sandboxRunner.ts

/**
 * åœ¨æ²™ç®±ä¸­è¿è¡Œæ’ä»¶
 */
export async function runPluginInSandbox(
  pluginModulePath: string,
  inputs: any,
  contextObj: PluginContext,
  options?: SandboxOptions
): Promise<SandboxResult> {
  // è‡ªåŠ¨é€‰æ‹© vm2 (æ¨è) æˆ– native vm (å›é€€)
  // ...
}
```

### 9. é›†æˆç¤ºä¾‹

å®Œæ•´çš„å®‰å…¨å®‰è£…æµç¨‹ï¼š

```typescript
import { installPluginFromPath } from '@tradespro/calculation-engine';

// å®‰è£…å¹¶éªŒè¯ç¬¬ä¸‰æ–¹æ’ä»¶
const { plugin, verification } = await installPluginFromPath('/path/to/plugin', {
  // ç­¾åéªŒè¯
  verifySignature: true,
  verifyChecksum: true,
  publicKeyPath: '/path/to/public.pem',
  requireSignature: process.env.NODE_ENV === 'production',
  
  // æ²™ç®±é…ç½®
  useSandbox: true,
  sandboxOptions: {
    mode: 'vm2',
    timeoutMs: 5000,
    memoryLimitMb: 64,
    allowRequire: false,
  },
});

console.log(`Plugin installed: ${plugin.manifest.name}`);
console.log(`Signature valid: ${verification.signatureValid}`);
console.log(`Checksum valid: ${verification.checksumValid}`);
```

---

## ğŸ“¦ ä¾èµ–æ›´æ–°

### package.json

å·²æ·»åŠ å¯é€‰ä¾èµ–ï¼š

```json
{
  "optionalDependencies": {
    "vm2": "^3.9.19"
  },
  "devDependencies": {
    "@types/vm2": "^3.9.9"
  }
}
```

### å®‰è£… vm2

```bash
npm install vm2@^3.9.19
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **[PLUGIN_SECURITY.md](./PLUGIN_SECURITY.md)** - å®Œæ•´å®‰å…¨æŒ‡å—å’Œä½¿ç”¨ç¤ºä¾‹
- **[PLUGIN_SYSTEM.md](./PLUGIN_SYSTEM.md)** - æ’ä»¶ç³»ç»Ÿå®Œæ•´æ–‡æ¡£

---
## ğŸ’» æ ¸å¿ƒå®ç°ä»£ç 

### 1. ç±»å‹å®šä¹‰ (types.ts)

å®Œæ•´çš„ç±»å‹ç³»ç»Ÿå®šä¹‰ï¼Œä¸ºæ’ä»¶ç³»ç»Ÿæä¾›ç±»å‹å®‰å…¨ä¿éšœï¼š

```typescript
// @tradespro/calculation-engine/src/plugins/types.ts
import type { EngineMeta, RuleTables, UnsignedBundle } from '../core/types';

/**
 * Plugin Manifest - æ’ä»¶å…ƒæ•°æ®å®šä¹‰
 */
export interface PluginManifest {
  // æ’ä»¶æ ‡è¯†
  id: string;                    // å”¯ä¸€IDï¼Œå¦‚ "cec-single-dwelling-2024"
  name: string;                  // æ˜¾ç¤ºåç§°
  version: string;               // è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼Œå¦‚ "1.0.0"
  description: string;           // æ’ä»¶æè¿°
  author?: string;               // ä½œè€…
  license?: string;              // è®¸å¯è¯

  // æ’ä»¶èƒ½åŠ›
  domain: 'electrical' | 'hvac' | 'plumbing' | 'gas' | 'fire_alarm' | 'other';
  standards: string[];           // æ”¯æŒçš„æ ‡å‡†ï¼Œå¦‚ ["CEC-2024", "CEC-8-200"]
  buildingTypes: string[];       // æ”¯æŒçš„å»ºç­‘ç±»å‹
  
  // è¿è¡Œæ—¶èƒ½åŠ›
  capabilities: {
    offline: boolean;            // æ˜¯å¦æ”¯æŒç¦»çº¿è¿è¡Œ
    audit: boolean;              // æ˜¯å¦æ”¯æŒå®¡è®¡è½¨è¿¹
    signing: boolean;            // æ˜¯å¦æ”¯æŒç­¾å
    preview: boolean;            // æ˜¯å¦æ”¯æŒé¢„è§ˆæ¨¡å¼
  };

  // æ’ä»¶ç»“æ„
  entry: string;                 // å…¥å£æ–‡ä»¶
  tables?: string[];             // éœ€è¦çš„è¡¨æ–‡ä»¶
  schema?: string;               // è¾“å…¥schemaæ–‡ä»¶
  
  // ä¾èµ–å…³ç³»
  dependencies?: {
    plugins?: string[];          // ä¾èµ–çš„å…¶ä»–æ’ä»¶ID
    tables?: string[];           // éœ€è¦çš„è¡¨ID
    minEngineVersion?: string;   // æœ€ä½å¼•æ“ç‰ˆæœ¬
  };

  // å®‰å…¨ä¸éªŒè¯
  signature?: string;            // æ’ä»¶ç­¾å
  checksum?: string;             // SHA-256æ ¡éªŒå’Œ
  
  // å…ƒæ•°æ®
  tags?: string[];               // æ ‡ç­¾
  icon?: string;                 // å›¾æ ‡è·¯å¾„
  homepage?: string;             // ä¸»é¡µ
  repository?: string;           // ä»£ç ä»“åº“
}

/**
 * Plugin Context - è¿è¡Œæ—¶ä¸Šä¸‹æ–‡
 */
export interface PluginContext {
  engine: EngineMeta;           // å¼•æ“å…ƒæ•°æ®
  tables: RuleTables;           // è§„åˆ™è¡¨
  options?: {
    locale?: string;
    mode?: 'preview' | 'official';
    tier?: 'free' | 'premium' | 'enterprise';
  };
  logger: {
    info: (message: string) => void;
    warn: (message: string) => void;
    error: (message: string) => void;
    debug?: (message: string) => void;
  };
}

/**
 * Plugin Calculation Result
 */
export interface PluginCalculationResult {
  bundle: UnsignedBundle;
  executionTimeMs?: number;
  warnings?: string[];
  errors?: string[];
}

/**
 * Calculation Plugin Interface - æ‰€æœ‰æ’ä»¶å¿…é¡»å®ç°çš„æ¥å£
 */
export interface CalculationPlugin {
  manifest: PluginManifest;
  
  // è¾“å…¥éªŒè¯ï¼ˆå¯é€‰ï¼‰
  validateInputs?(inputs: any): { valid: boolean; errors?: string[] };
  
  // ä¸»è®¡ç®—å‡½æ•°ï¼ˆå¿…éœ€ï¼‰
  calculate(
    inputs: any,
    context: PluginContext
  ): PluginCalculationResult | Promise<PluginCalculationResult>;
  
  // è·å–éœ€è¦çš„è¡¨ï¼ˆå¯é€‰ï¼‰
  getRequiredTables?(): string[];
  
  // è·å–è¾“å…¥schemaï¼ˆå¯é€‰ï¼‰
  getInputSchema?(): PluginInputSchema;
  
  // ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå¯é€‰ï¼‰
  onInstall?(): void | Promise<void>;
  onUninstall?(): void | Promise<void>;
  onLoad?(): void | Promise<void>;
}

/**
 * Plugin Registry Entry
 */
export interface PluginRegistryEntry {
  plugin: CalculationPlugin;
  installInfo: PluginInstallInfo;
  loaded: boolean;
  loadError?: string;
}
```

### 2. Plugin Registry å®ç° (registry.ts)

æ’ä»¶æ³¨å†Œè¡¨çš„æ ¸å¿ƒå®ç°ï¼Œç®¡ç†æ‰€æœ‰æ’ä»¶çš„æ³¨å†Œã€æŸ¥æ‰¾å’Œç®¡ç†ï¼š

```typescript
// @tradespro/calculation-engine/src/plugins/registry.ts
import type { CalculationPlugin, PluginRegistryEntry, PluginInstallInfo } from './types';

class PluginRegistry {
  private plugins: Map<string, PluginRegistryEntry> = new Map();
  private defaultPlugins: Map<string, CalculationPlugin> = new Map();

  /**
   * æ³¨å†Œæ’ä»¶
   */
  register(plugin: CalculationPlugin, installInfo?: Partial<PluginInstallInfo>): void {
    const pluginId = plugin.manifest.id;
    
    // æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œ
    if (this.plugins.has(pluginId)) {
      console.warn(`Plugin ${pluginId} is already registered. Overwriting...`);
    }

    // åˆ›å»ºå®‰è£…ä¿¡æ¯
    const fullInstallInfo: PluginInstallInfo = {
      pluginId,
      version: plugin.manifest.version,
      installedAt: new Date().toISOString(),
      status: 'installed',
      manifest: plugin.manifest,
      ...installInfo,
    };

    // æ³¨å†Œæ’ä»¶
    const entry: PluginRegistryEntry = {
      plugin,
      installInfo: fullInstallInfo,
      loaded: false,
    };

    this.plugins.set(pluginId, entry);

    // è°ƒç”¨onLoadé’©å­
    try {
      if (plugin.onLoad) {
        plugin.onLoad();
      }
      entry.loaded = true;
    } catch (error) {
      entry.loaded = false;
      entry.loadError = error instanceof Error ? error.message : 'Unknown error';
      entry.installInfo.status = 'error';
      console.error(`Failed to load plugin ${pluginId}:`, error);
    }

    console.log(`âœ… Plugin registered: ${pluginId} v${plugin.manifest.version}`);
  }

  /**
   * æ³¨å†Œå†…ç½®æ’ä»¶
   */
  registerDefault(plugin: CalculationPlugin): void {
    this.defaultPlugins.set(plugin.manifest.id, plugin);
    this.register(plugin, { status: 'active' });
  }

  /**
   * è·å–æ’ä»¶
   */
  get(pluginId: string): CalculationPlugin | null {
    const entry = this.plugins.get(pluginId);
    return entry?.plugin || null;
  }

  /**
   * æ£€æŸ¥æ’ä»¶æ˜¯å¦æ³¨å†Œ
   */
  has(pluginId: string): boolean {
    return this.plugins.has(pluginId);
  }

  /**
   * æ£€æŸ¥æ’ä»¶æ˜¯å¦å·²åŠ è½½
   */
  isLoaded(pluginId: string): boolean {
    const entry = this.plugins.get(pluginId);
    return entry?.loaded || false;
  }

  /**
   * æ³¨é”€æ’ä»¶
   */
  unregister(pluginId: string): boolean {
    const entry = this.plugins.get(pluginId);
    if (!entry) {
      return false;
    }

    // è°ƒç”¨onUninstallé’©å­
    try {
      if (entry.plugin.onUninstall) {
        entry.plugin.onUninstall();
      }
    } catch (error) {
      console.error(`Error during plugin uninstall ${pluginId}:`, error);
    }

    this.plugins.delete(pluginId);
    console.log(`âœ… Plugin unregistered: ${pluginId}`);
    return true;
  }

  /**
   * åˆ—å‡ºæ‰€æœ‰æ’ä»¶
   */
  list(): CalculationPlugin[] {
    return Array.from(this.plugins.values()).map(entry => entry.plugin);
  }

  /**
   * æŒ‰åŸŸæŸ¥æ‰¾æ’ä»¶
   */
  listByDomain(domain: string): CalculationPlugin[] {
    return this.list().filter(p => p.manifest.domain === domain);
  }

  /**
   * æŒ‰æ ‡å‡†æŸ¥æ‰¾æ’ä»¶
   */
  listByStandard(standard: string): CalculationPlugin[] {
    return this.list().filter(p => 
      p.manifest.standards.some(s => s.toLowerCase().includes(standard.toLowerCase()))
    );
  }

  /**
   * æŒ‰å»ºç­‘ç±»å‹æŸ¥æ‰¾æ’ä»¶
   */
  listByBuildingType(buildingType: string): CalculationPlugin[] {
    return this.list().filter(p => 
      p.manifest.buildingTypes.includes(buildingType)
    );
  }

  /**
   * è·å–æ’ä»¶æ•°é‡
   */
  count(): number {
    return this.plugins.size;
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export const pluginRegistry = new PluginRegistry();
```

### 3. Plugin Loader å®ç° (loader.ts)

æ’ä»¶åŠ è½½å™¨çš„æ ¸å¿ƒå®ç°ï¼Œè´Ÿè´£åŠ è½½ã€éªŒè¯å’Œæ‰§è¡Œæ’ä»¶ï¼š

```typescript
// @tradespro/calculation-engine/src/plugins/loader.ts
import type { CalculationPlugin, PluginManifest, PluginContext } from './types';
import { pluginRegistry } from './registry';

export interface PluginLoadOptions {
  verifySignature?: boolean;
  verifyChecksum?: boolean;
  allowUnverified?: boolean;
}

/**
 * ä»æ¨¡å—åŠ è½½æ’ä»¶
 */
export async function loadPlugin(
  pluginModule: any,
  options: PluginLoadOptions = {}
): Promise<CalculationPlugin> {
  // æå–æ’ä»¶ - å¯ä»¥æ˜¯é»˜è®¤å¯¼å‡ºæˆ–å‘½åå¯¼å‡º
  let plugin: CalculationPlugin;
  
  if (pluginModule.default && typeof pluginModule.default.calculate === 'function') {
    plugin = pluginModule.default;
  } else if (typeof pluginModule.calculate === 'function') {
    plugin = pluginModule;
  } else {
    throw new Error('Invalid plugin module: must export a CalculationPlugin');
  }

  // éªŒè¯æ’ä»¶ç»“æ„
  validatePlugin(plugin, options);

  return plugin;
}

/**
 * éªŒè¯æ’ä»¶ç»“æ„å’Œè¦æ±‚
 */
export function validatePlugin(
  plugin: CalculationPlugin,
  options: PluginLoadOptions = {}
): void {
  // æ£€æŸ¥å¿…éœ€å­—æ®µ
  if (!plugin.manifest) {
    throw new Error('Plugin must have a manifest');
  }

  if (!plugin.manifest.id) {
    throw new Error('Plugin manifest must have an id');
  }

  if (!plugin.manifest.version) {
    throw new Error('Plugin manifest must have a version');
  }

  if (typeof plugin.calculate !== 'function') {
    throw new Error('Plugin must implement calculate() method');
  }

  // éªŒè¯manifestç»“æ„
  const m = plugin.manifest;
  if (!m.domain || !m.standards || !Array.isArray(m.standards)) {
    throw new Error('Plugin manifest must have domain and standards array');
  }

  if (!m.capabilities || typeof m.capabilities !== 'object') {
    throw new Error('Plugin manifest must have capabilities object');
  }

  // æ£€æŸ¥ä¾èµ–
  if (m.dependencies?.plugins) {
    for (const depId of m.dependencies.plugins) {
      if (!pluginRegistry.has(depId)) {
        throw new Error(`Plugin ${m.id} depends on plugin ${depId} which is not installed`);
      }
    }
  }
}

/**
 * åˆ›å»ºæ’ä»¶ä¸Šä¸‹æ–‡
 */
export function createPluginContext(
  engine: PluginContext['engine'],
  tables: PluginContext['tables'],
  options?: PluginContext['options']
): PluginContext {
  return {
    engine,
    tables,
    options,
    logger: {
      info: (msg: string) => console.log(`[Plugin] ${msg}`),
      warn: (msg: string) => console.warn(`[Plugin] ${msg}`),
      error: (msg: string) => console.error(`[Plugin] ${msg}`),
      debug: (msg: string) => {
        if (options?.mode === 'preview' || process.env.NODE_ENV === 'development') {
          console.debug(`[Plugin] ${msg}`);
        }
      },
    },
  };
}

/**
 * æ‰§è¡Œæ’ä»¶è®¡ç®—
 */
export async function executePlugin(
  pluginId: string,
  inputs: any,
  context: PluginContext
): Promise<import('./types').PluginCalculationResult> {
  const plugin = pluginRegistry.get(pluginId);
  if (!plugin) {
    throw new Error(`Plugin ${pluginId} not found`);
  }

  if (!pluginRegistry.isLoaded(pluginId)) {
    throw new Error(`Plugin ${pluginId} is not loaded`);
  }

  // éªŒè¯è¾“å…¥ï¼ˆå¦‚æœæ’ä»¶æä¾›äº†éªŒè¯å™¨ï¼‰
  if (plugin.validateInputs) {
    const validation = plugin.validateInputs(inputs);
    if (!validation.valid) {
      throw new Error(`Input validation failed: ${validation.errors?.join(', ')}`);
    }
  }

  // æ‰§è¡Œè®¡ç®—
  const startTime = Date.now();
  try {
    const result = await plugin.calculate(inputs, context);
    const executionTime = Date.now() - startTime;
    
    return {
      ...result,
      executionTimeMs: result.executionTimeMs ?? executionTime,
    };
  } catch (error) {
    context.logger.error(`Plugin ${pluginId} calculation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
    throw error;
  }
}
```

### 4. å®Œæ•´æ’ä»¶ç¤ºä¾‹ (cec-single-dwelling-plugin.ts)

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ’ä»¶å®ç°ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•å°†ç°æœ‰è®¡ç®—åŠŸèƒ½å°è£…ä¸ºæ’ä»¶ï¼š

```typescript
// @tradespro/calculation-engine/src/plugins/builtin/cec-single-dwelling-plugin.ts
// V4.1 Plugin System - CEC Single Dwelling Load Calculator Plugin
// å°† computeSingleDwelling åŒ…è£…ä¸ºæ’ä»¶

import type { CalculationPlugin, PluginContext, PluginCalculationResult } from '../types';
import type { CecInputsSingle } from '../../core/types';
import { computeSingleDwelling } from '../../rules/8-200-single-dwelling';

export const cecSingleDwellingPlugin: CalculationPlugin = {
  // æ’ä»¶å…ƒæ•°æ®
  manifest: {
    id: 'cec-single-dwelling-2024',
    name: 'CEC 2024 Single Dwelling Load Calculator',
    version: '1.0.0',
    description: 'Calculates electrical load for single dwelling units per CEC Section 8-200',
    author: 'TradesPro',
    license: 'MIT',
    domain: 'electrical',
    standards: ['CEC-2024', 'CEC-8-200'],
    buildingTypes: ['single-dwelling'],
    capabilities: {
      offline: true,
      audit: true,
      signing: true,
      preview: true,
    },
    entry: 'cec-single-dwelling-plugin.ts',
    tables: ['table2', 'table4', 'table5A', 'table5C'],
    tags: ['cec', 'single-dwelling', 'residential', 'load-calculation', 'canada'],
    homepage: 'https://github.com/tradespro/tradespro',
  },

  // è¾“å…¥éªŒè¯
  validateInputs(inputs: any): { valid: boolean; errors?: string[] } {
    const errors: string[] = [];
    
    if (!inputs || typeof inputs !== 'object') {
      errors.push('Inputs must be an object');
      return { valid: false, errors };
    }

    if (typeof inputs.systemVoltage !== 'number' || inputs.systemVoltage <= 0) {
      errors.push('systemVoltage is required and must be a positive number');
    }

    if (inputs.livingArea_m2 !== undefined && (typeof inputs.livingArea_m2 !== 'number' || inputs.livingArea_m2 < 0)) {
      errors.push('livingArea_m2 must be a non-negative number if provided');
    }

    return {
      valid: errors.length === 0,
      errors: errors.length > 0 ? errors : undefined,
    };
  },

  // è·å–éœ€è¦çš„è¡¨
  getRequiredTables(): string[] {
    return ['table2', 'table4', 'table5A', 'table5C'];
  },

  // ä¸»è®¡ç®—å‡½æ•°
  async calculate(
    inputs: any,
    context: PluginContext
  ): Promise<PluginCalculationResult> {
    // éªŒè¯è¾“å…¥
    const validation = this.validateInputs!(inputs);
    if (!validation.valid) {
      throw new Error(`Input validation failed: ${validation.errors?.join(', ')}`);
    }

    // ç¡®ä¿å¼•æ“commitå·²è®¾ç½®ï¼ˆV4.1è¦æ±‚ï¼‰
    if (!context.engine.commit || context.engine.commit.startsWith('placeholder')) {
      context.logger.warn('Engine commit not set - using fallback value');
      context.engine.commit = context.engine.commit || 'plugin-dev';
    }

    // æ‰§è¡Œè®¡ç®—
    const startTime = Date.now();
    try {
      // è°ƒç”¨ç°æœ‰çš„è®¡ç®—å‡½æ•°
      const bundle = computeSingleDwelling(
        inputs as CecInputsSingle,
        context.engine,
        context.tables
      );

      const executionTime = Date.now() - startTime;

      context.logger.info(`Calculation completed in ${executionTime}ms`);

      return {
        bundle,
        executionTimeMs: executionTime,
        warnings: bundle.warnings || [],
      };
    } catch (error) {
      context.logger.error(`Calculation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
      throw error;
    }
  },

  // ç”Ÿå‘½å‘¨æœŸé’©å­
  onLoad(): void {
    console.log('âœ… CEC Single Dwelling Plugin loaded');
  },
};

export default cecSingleDwellingPlugin;
```

### 5. ä½¿ç”¨ç¤ºä¾‹

å®Œæ•´çš„æ’ä»¶ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹ï¼š

```typescript
// ç¤ºä¾‹ï¼šä½¿ç”¨æ’ä»¶ç³»ç»Ÿè¿›è¡Œè®¡ç®—

import { 
  pluginRegistry, 
  executePlugin, 
  createPluginContext 
} from '@tradespro/calculation-engine';
import { tableManager } from '@tradespro/calculation-engine';

// ===== 1. æŸ¥æ‰¾å¯ç”¨æ’ä»¶ =====
const allPlugins = pluginRegistry.list();
console.log('æ‰€æœ‰å·²æ³¨å†Œæ’ä»¶:', allPlugins.map(p => p.manifest.name));

const electricalPlugins = pluginRegistry.listByDomain('electrical');
console.log('ç”µæ°”æ’ä»¶:', electricalPlugins.map(p => p.manifest.id));

const cecPlugins = pluginRegistry.listByStandard('CEC-2024');
console.log('CEC 2024æ’ä»¶:', cecPlugins.map(p => p.manifest.id));

// ===== 2. å‡†å¤‡è¾“å…¥æ•°æ® =====
const inputs = {
  systemVoltage: 240,
  livingArea_m2: 150,
  phase: 1,
  // ... æ›´å¤šè¾“å…¥å­—æ®µ
};

// ===== 3. å‡†å¤‡å¼•æ“å…ƒæ•°æ® =====
const engineMeta = {
  name: 'tradespro-engine',
  version: '1.0.0',
  commit: process.env.GIT_COMMIT || 'dev',
};

// ===== 4. åŠ è½½è§„åˆ™è¡¨ =====
const tables = await tableManager.loadTables('2024');

// ===== 5. åˆ›å»ºæ’ä»¶ä¸Šä¸‹æ–‡ =====
const context = createPluginContext(engineMeta, tables, {
  mode: 'official',
  tier: 'premium',
  locale: 'en-CA',
});

// ===== 6. æ‰§è¡Œæ’ä»¶è®¡ç®— =====
try {
  const pluginId = 'cec-single-dwelling-2024';
  
  // æ£€æŸ¥æ’ä»¶æ˜¯å¦å­˜åœ¨
  if (!pluginRegistry.has(pluginId)) {
    throw new Error(`Plugin ${pluginId} not found`);
  }

  // æ‰§è¡Œè®¡ç®—
  const result = await executePlugin(pluginId, inputs, context);
  
  console.log('è®¡ç®—ç»“æœ:', result.bundle);
  console.log('æ‰§è¡Œæ—¶é—´:', result.executionTimeMs, 'ms');
  console.log('è­¦å‘Š:', result.warnings);
  
  // è®¿é—®è®¡ç®—ç»“æœ
  const totalLoad = result.bundle.results.totalLoad;
  const steps = result.bundle.steps; // å®¡è®¡è½¨è¿¹
  
} catch (error) {
  console.error('è®¡ç®—å¤±è´¥:', error);
}

// ===== 7. è·å–æ’ä»¶ä¿¡æ¯ =====
const plugin = pluginRegistry.get('cec-single-dwelling-2024');
if (plugin) {
  console.log('æ’ä»¶åç§°:', plugin.manifest.name);
  console.log('æ’ä»¶ç‰ˆæœ¬:', plugin.manifest.version);
  console.log('æ”¯æŒçš„æ ‡å‡†:', plugin.manifest.standards);
  console.log('èƒ½åŠ›:', plugin.manifest.capabilities);
  console.log('éœ€è¦çš„è¡¨:', plugin.getRequiredTables?.());
}
```

### 6. æ’ä»¶ç³»ç»Ÿå…¥å£ (index.ts)

æ’ä»¶ç³»ç»Ÿçš„ä¸»å…¥å£æ–‡ä»¶ï¼Œè‡ªåŠ¨æ³¨å†Œå†…ç½®æ’ä»¶ï¼š

```typescript
// @tradespro/calculation-engine/src/plugins/index.ts
// V4.1 Plugin System - Main Entry Point

// å¯¼å‡ºç±»å‹
export * from './types';

// å¯¼å‡ºæ³¨å†Œè¡¨
export { pluginRegistry } from './registry';

// å¯¼å‡ºåŠ è½½å™¨å·¥å…·
export * from './loader';

// å¯¼å‡ºå†…ç½®æ’ä»¶
export { cecSingleDwellingPlugin } from './builtin/cec-single-dwelling-plugin';
export { necSingleDwellingPlugin } from './builtin/nec-single-dwelling-plugin';

// è‡ªåŠ¨æ³¨å†Œå†…ç½®æ’ä»¶
import { pluginRegistry } from './registry';
import { cecSingleDwellingPlugin } from './builtin/cec-single-dwelling-plugin';
import { necSingleDwellingPlugin } from './builtin/nec-single-dwelling-plugin';

// æ³¨å†Œå†…ç½®æ’ä»¶
pluginRegistry.registerDefault(cecSingleDwellingPlugin);
pluginRegistry.registerDefault(necSingleDwellingPlugin);
```

---

## ğŸ¯ è®¾è®¡è¦ç‚¹ä¸è¯„ä¼°

### 1. æ¶æ„ä¼˜åŠ¿

- **å•ä¸€èŒè´£åŸåˆ™**: Registryè´Ÿè´£ç®¡ç†ï¼ŒLoaderè´Ÿè´£åŠ è½½å’Œæ‰§è¡Œï¼Œç±»å‹å®šä¹‰æ¸…æ™°åˆ†ç¦»
- **å¯æ‰©å±•æ€§**: é€šè¿‡ç»Ÿä¸€çš„æ¥å£ï¼Œæ–°æ’ä»¶å¯ä»¥è½»æ¾é›†æˆï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
- **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰ï¼Œç¼–è¯‘æ—¶å³å¯å‘ç°é”™è¯¯
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: é€šè¿‡`onLoad`ã€`onInstall`ã€`onUninstall`é’©å­æ”¯æŒå®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸ
- **ä¾èµ–æ£€æŸ¥**: è‡ªåŠ¨æ£€æŸ¥æ’ä»¶ä¾èµ–ï¼Œç¡®ä¿ä¾èµ–å·²å®‰è£…

### 2. å…³é”®è®¾è®¡å†³ç­–

1. **å•ä¾‹Registry**: ä½¿ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªæ’ä»¶æ³¨å†Œè¡¨ï¼Œé¿å…é‡å¤æ³¨å†Œ
2. **å¼‚æ­¥è®¡ç®—**: `calculate`æ–¹æ³•æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ï¼Œé€‚åº”ä¸åŒè®¡ç®—åœºæ™¯
3. **ä¸Šä¸‹æ–‡æ³¨å…¥**: é€šè¿‡`PluginContext`æ³¨å…¥ä¾èµ–ï¼ˆå¼•æ“ã€è¡¨ã€æ—¥å¿—ï¼‰ï¼Œè€Œä¸æ˜¯å…¨å±€è®¿é—®
4. **éªŒè¯åˆ†å±‚**: è¾“å…¥éªŒè¯åœ¨æ’ä»¶å±‚é¢å’Œç³»ç»Ÿå±‚é¢åŒé‡éªŒè¯ï¼Œæé«˜å®‰å…¨æ€§
5. **å‘åå…¼å®¹**: åŒ…è£…ç°æœ‰å‡½æ•°ä¸ºæ’ä»¶ï¼Œä¿æŒåŸæœ‰APIå¯ç”¨

### 3. å®‰å…¨ç‰¹æ€§ âœ… (æ–°å¢)

- **æ’ä»¶ç­¾åéªŒè¯** âœ…: å®Œæ•´å®ç° RSA/ECDSA ç­¾åéªŒè¯
  - `signatureVerifier.ts` - æä¾›ç­¾åã€æ ¡éªŒå’ŒéªŒè¯åŠŸèƒ½
  - æ”¯æŒ SHA-256 æ ¡éªŒå’ŒéªŒè¯
  - æ”¯æŒ RSA-SHA256 ç­¾åéªŒè¯
- **æ’ä»¶æ²™ç®±** âœ…: åœ¨éš”ç¦»ç¯å¢ƒä¸­æ‰§è¡Œæ’ä»¶
  - `sandboxRunner.ts` - æ”¯æŒ vm2ï¼ˆæ¨èï¼‰å’ŒåŸç”Ÿ vmï¼ˆå›é€€ï¼‰
  - å†…å­˜å’Œæ—¶é—´é™åˆ¶
  - æ¨¡å—è®¿é—®æ§åˆ¶
- **å®Œæ•´çš„å®‰å…¨æµç¨‹**: 
  - å®‰è£…æ—¶éªŒè¯ç­¾åå’Œæ ¡éªŒå’Œ
  - æœªä¿¡ä»»æ’ä»¶åœ¨æ²™ç®±ä¸­æ‰§è¡Œ
  - ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ç­¾åè¦æ±‚

### 4. å¯æ”¹è¿›æ–¹å‘

- **çƒ­é‡è½½**: æ”¯æŒå¼€å‘ç¯å¢ƒä¸‹æ’ä»¶çš„çƒ­é‡è½½ï¼Œæå‡å¼€å‘ä½“éªŒ
- **æ€§èƒ½ç›‘æ§**: æ·»åŠ æ’ä»¶æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡åŠŸèƒ½
- **æµè§ˆå™¨æ²™ç®±**: åœ¨æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨Web Workerå®ç°æ²™ç®±éš”ç¦»

### 5. æŠ€æœ¯æ ˆå…¼å®¹æ€§

- âœ… **Node.js**: å®Œå…¨æ”¯æŒï¼Œå¯ç”¨äºåç«¯æœåŠ¡
- âœ… **æµè§ˆå™¨**: å®Œå…¨æ”¯æŒï¼Œå¯ç”¨äºå‰ç«¯åº”ç”¨
- âœ… **TypeScript**: å®Œæ•´ç±»å‹å®šä¹‰ï¼Œæä¾›è‰¯å¥½çš„å¼€å‘ä½“éªŒ
- âœ… **æ¨¡å—ç³»ç»Ÿ**: æ”¯æŒES Moduleå’ŒCommonJSï¼ˆé€šè¿‡æ‰“åŒ…å·¥å…·ï¼‰

---
